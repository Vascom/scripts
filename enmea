#!/bin/bash

if [ -z "$1" -o -z "$2" ]
then
    echo "Format isn't correct!"
    echo "Use:"
    echo "enmea input_file output_filename [show_progress]"
    exit
fi

IN_FILE_LIST=$1
GGA_decode_counter=0
GSV_decode_counter=0
unknown_decode_counter=0
sat_v=( 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 )
sat_v_notnull=( 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 )

total_GGA=`grep -c GGA "$1"`
# message_time_PRE=`cat $IN_FILE_LIST | grep GPGGA -m 1 | cut -d "," -f2 | cut -d "." -f1`
# message_time=`expr $message_time_PRE - 1`

function number_to_decimal() {
    if [ "$sv_number" == "08" ] || [ "$sv_number" == "09" ]
    then
        sv_number=`expr $sv_number + 0`
    fi
}

function number_check() {
    if [ -z "${sat_v[$1]}" ]
    then
        sat_v[$1]=0
    else
        sat_v_notnull[$1]=${sat_v[$1]}
    fi
}

#rm -rf /tmp/nmea/log
FILE_IN=`cat $IN_FILE_LIST`

for one_string in `echo "$FILE_IN"`
do
    navmes=`echo "$one_string" | cut -d "," -f1`
    if [ "$navmes" == "\$GPGGA" ]
    then
        #message_time_H=`echo "$one_string" | cut -c8,9`
        #message_time_M=`echo "$one_string" | cut -c9,10`
        #message_time_S=`echo "$one_string" | cut -c11,12`
        #message_time=`expr $message_time_H * 3600 + $message_time_M * 60 + $message_time_S`
        message_time=`echo "$one_string" | cut -d "," -f2 | cut -d "." -f1`

        #LATITUDE=`echo "$one_string" | cut -d "," -f3`
        #N_S=`echo "$one_string" | cut -d "," -f4`
        #LONGITUDE=`echo "$one_string" | cut -d "," -f5`
        #E_W=`echo "$one_string" | cut -d "," -f6`
        #GPS_QUALITY=`echo "$one_string" | cut -d "," -f7`
        #TOTAL_SATELLITES=`echo "$one_string" | cut -d "," -f8`
        hdop=`echo "$one_string" | cut -d "," -f9`
        if [ -z "$hdop" ]
        then
            hdop=0
        fi
        #ALTITUDE=`echo "$one_string" | cut -d "," -f10`
        #ALTITUDE_UNITS=`echo "$one_string" | cut -d "," -f11`
        #GEOIDAL_SEPARATION=`echo "$one_string" | cut -d "," -f12`
        #GEOIDAL_SEPARATION_UNITS=`echo "$one_string" | cut -d "," -f13`
        #message_time=`echo "$one_string" | cut -d "," -f14`
        #message_time=`echo "$one_string" | cut -d "," -f15`
        #message_time=`echo "$one_string" | cut -d "," -f16`
        GGA_decode_counter=`expr $GGA_decode_counter + 1`
        #sat_v contain 33 vars: message_time + 32 satellites
        sat_v=( 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 )

        if [ -z "$3" ]
        then
            echo -ne "\rGGA: $GGA_decode_counter of $total_GGA"
        fi
    elif [ "$navmes" == "\$GPGSV" ]
    then
        total_messages=`echo "$one_string" | cut -d "," -f2`
        message_number=`echo "$one_string" | cut -d "," -f3`
#         TOTAL_SV=`echo "$one_string" | cut -d "," -f4`

        sv_number=`echo "$one_string" | cut -d "," -f5`
        number_to_decimal
#             ELEVATION[$M]=`echo "$one_string" | cut -d "," -f${FF[1]}`
#             AZIMUTH[$M]=`echo "$one_string" | cut -d "," -f${FF[2]}`
        sat_v[$sv_number]=`echo "$one_string" | cut -d "," -f8 | cut -d "*" -f1`
        number_check $sv_number

        sv_number=`echo "$one_string" | cut -d "," -f9`
        number_to_decimal
        if [ -n "$sv_number" ]
        then
            sat_v[$sv_number]=`echo "$one_string" | cut -d "," -f12 | cut -d "*" -f1`
            number_check $sv_number

            sv_number=`echo "$one_string" | cut -d "," -f13`
            number_to_decimal
            if [ -n "$sv_number" ]
            then
                sat_v[$sv_number]=`echo "$one_string" | cut -d "," -f16 | cut -d "*" -f1`
                number_check $sv_number

                sv_number=`echo "$one_string" | cut -d "," -f17`
                number_to_decimal
                if [ -n "$sv_number" ]
                then
                    sat_v[$sv_number]=`echo "$one_string" | cut -d "," -f20 | cut -d "*" -f1`
                    number_check $sv_number
                fi
            fi
        fi

        if [ "$total_messages" == "$message_number" ]
        then
            sat_v[0]=$message_time
            echo "${sat_v[@]} $hdop" >> "$2"
            #/home/vascom/sat/log
        fi

        #GSV_decode_counter=`expr $GSV_decode_counter + 1`
    else
        echo -n ""
        #echo "Unknown Navigation message"
        #$unknown_decode_counter=`expr $unknown_decode_counter + 1`
    fi
done

#echo -e "\nGSV: $GSV_decode_counter"
if [ -n "$3" ]
then
    echo -ne "GGA: $GGA_decode_counter of $total_GGA"
fi
echo -e "\nUnknown: $unknown_decode_counter"

echo -n "Detected satellites: "
for ((k=1; k < 33 ; k++))
do
    if [ "${sat_v_notnull[$k]}" != "0" ]
    then
        echo -n "$k "
        #echo -n "${sat_v_notnull[$k]} "
    fi
done
echo ""

