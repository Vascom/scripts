#!/bin/bash

SEQ="4 5 6"
NUMBER_LINES=`head -n 1 $1 | cut -d "," -f2`
TEMP_LINE=`head -n $NUMBER_LINES $1 | tail -n +2`

for n in $TEMP_LINE
do
    BUILD_ENABLE=`echo $n | cut -d "," -f11`
    if [ "$BUILD_ENABLE" = "+" ]
    then
        NAME=`echo $n | cut -d "," -f1`
        REV=`echo $n | cut -d "," -f3`
        for k in $SEQ
        do
            STATE=`echo $n | cut -d "," -f$k`
            BUILD=`expr $k + 10`
            if [[ "$STATE" = "-" && "$2" != "repo" ]]
            then
                SCRATCH=`echo $n | cut -d "," -f10`
                if [[ "$SCRATCH" = "-" || "$2" = "test" ]]
                then
                    TEST="test"
                else
                    TEST=""
                fi

                echo "Building $NAME $BUILD"
                ./koji_run $NAME $REV $BUILD $TEST
                sleep 5

            elif [[ ("$STATE" = '+' || "$STATE" = 'b+') && "$2" = "repo"  ]]
            then
                REPONUM=`expr $k + 3`
                INREPO=`echo $n | cut -d "," -f$REPONUM`
                if [[ "$INREPO" = "-" ]]
                then
                    echo "$NAME not in repo $BUILD"
                fi
            fi
        done
    fi
done
